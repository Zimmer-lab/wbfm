
# Global requirement
project_dir: "/scratch/neurobiology/zimmer/path/to/this/project"

# Step 0: preprocessing
# Also uses raw data and produces a .zarr.zip, but that will NOT be within this project, so is not included
output_0:
  - dat/bounding_boxes.pickle
script_0: 0b-preprocess_working_copy_of_data

# Step 1: segmentation
# NOTE: raw data is outside the project, and thus is not in this format
input_1:
  - dat/bounding_boxes.pickle
output_1_dir:
  - 1-segmentation/masks.zarr
output_1:
  - 1-segmentation/metadata.pickle
script_1: 1-segment_video

# Step 2: tracklets
input_2a_dir:
  - 1-segmentation/masks.zarr
input_2a:
  - 1-segmentation/metadata.pickle
output_2a:
  - 2-training_data/raw/frame_dat.pickle
script_2a: 2a-build_frame_objects

input_2b_dir:
  - 1-segmentation/masks.zarr
input_2b:
  - 1-segmentation/metadata.pickle
  - 2-training_data/raw/frame_dat.pickle
output_2b:
  - 2-training_data/raw/match_dat.pickle
script_2b: 2b-match_adjacent_volumes

input_2c:
  - 2-training_data/raw/frame_dat.pickle
  - 2-training_data/raw/match_dat.pickle
output_2c:
  - 2-training_data/all_tracklets.pickle
  - 2-training_data/raw/clust_df_dat.pickle
script_2c: 2c-postprocess_matches_to_tracklets

# Step 3: Tracking
input_3a:
  - 1-segmentation/metadata.pickle
  - 2-training_data/raw/frame_dat.pickle
output_3a:
  - 3-tracking/postprocessing/df_tracks_superglue.h5
script_3a: 3a-track_using_superglue

input_3b:
  - 3-tracking/postprocessing/df_tracks_superglue.h5
  - 2-training_data/all_tracklets.pickle
output_3b:
  - 3-tracking/postprocessing/combined_3d_tracks.h5
  - 3-tracking/global2tracklet.pickle
script_3b: 3b-match_tracklets_and_tracks_using_neuron_initialization

# Step 4: final traces
input_4:
  - 3-tracking/postprocessing/combined_3d_tracks.h5
  - 1-segmentation/metadata.pickle
output_4:
  - 4-traces/all_matches.pickle
  - 4-traces/red_traces.h5
  - 4-traces/green_traces.h5
output_4_dir:
  - 4-traces/reindexed_masks.zarr.zip
script_4: 4-make_final_traces


#
# FOR BEHAVIORAL ANALYSIS
#
# Deletes intermediate files in the behavior pipeline
delete_intermediate_files: True

# rule subtract background
do_inverse: True

#rule normalise
alpha: 0
beta: 255

#worm unet weights
worm_unet_weights : "/scratch/neurobiology/zimmer/centerline_pipeline/neural_networks/unet_worm.hdf5"

#rule stack_make_binary
threshold : 30
max_value : 255

#rule coil unet
coil_unet_weights : "/scratch/neurobiology/zimmer/centerline_pipeline/neural_networks/unet_worm_coil.hdf5"

# rule binarize_coil
coil_threshold : 240
coil_new_value : 255

#rule tiff2avi
fourcc : 0 #codec
fps : 83

# rule dlc_analyze_videos
dlc_model_configfile_path : "/scratch/neurobiology/zimmer/centerline_pipeline/neural_networks/deeplabcut_projects/wbfm_nose_tail-ulises-2023-01-04/config.yaml"
dlc_network_string : "DLC_resnet50_wbfm_nose_tailJan4shuffle1_1030000"
dlc_conda_env: "/scratch/neurobiology/zimmer/.conda/envs/HR_tracker"

# rule create centerline
nose : "nose" # how was the nose annotated as in DLC model? e.g. head, nose, Head, Nose, etc..
tail : "tail" # how was the tail annotated as in DLC model?
num_splines : 100

# averaging spline (X,Y,K) rule
averaging_window : 83

# rule annotate behaviour
pca_model : "/scratch/neurobiology/zimmer/centerline_pipeline/code/curvature/curvature/models/1738_20230403_eigenworm_PCA_bodypart_30_to_80.pkl"
initial_segment : 30
final_segment : 80
window : 100

# for turns annotation
turn_threshold : 0.5
turn_initial_segment : 10
turn_final_segment : 90
turn_avg_window : 500

# Hilbert
hilbert_averaging_window : 83
# Hilbert also uses the sampling frequency, which is the same as for the fft

# rule fft
sampling_frequency: 83
fft_averaging_window: 83

